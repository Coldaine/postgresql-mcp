name: Deploy to Raspberry Pi

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  IMAGE_NAME: coldquery
  PI_HOST: 100.65.198.61
  PI_USER: coldaine

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ARM64 image
        run: |
          docker buildx build \
            --platform linux/arm64 \
            --tag ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --tag ${{ env.IMAGE_NAME }}:latest \
            --output type=docker,dest=image.tar \
            .

      - name: Connect to Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PI_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ env.PI_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Transfer image to Pi
        run: |
          gzip -c image.tar | ssh ${{ env.PI_USER }}@${{ env.PI_HOST }} 'gunzip | docker load'

      - name: Prepare deployment directory
        run: |
          ssh ${{ env.PI_USER }}@${{ env.PI_HOST }} 'mkdir -p ~/coldquery'

      - name: Copy docker-compose.deploy.yml
        run: |
          scp docker-compose.deploy.yml ${{ env.PI_USER }}@${{ env.PI_HOST }}:~/coldquery/docker-compose.yml

      - name: Deploy with Docker Compose
        run: |
          ssh ${{ env.PI_USER }}@${{ env.PI_HOST }} <<EOF
            cd ~/coldquery

            # Export secrets as env vars
            export TAILSCALE_AUTH_KEY=${{ secrets.TAILSCALE_AUTH_KEY }}
            export PGPASSWORD=${{ secrets.PI_POSTGRES_PASSWORD }}

            # Login to Docker (if needed, but we used load)

            # Start services
            docker-compose down
            docker-compose up -d

            # Wait for container to be healthy
            echo "Waiting for health check..."
            # Note: Health check inside the container might still refer to localhost:3000
            for i in {1..30}; do
              if docker exec coldquery wget --no-verbose --tries=1 --spider http://localhost:3000/health 2>/dev/null; then
                echo "Container is healthy!"
                exit 0
              fi
              echo "Attempt \$i/30 - waiting..."
              sleep 2
            done
            echo "Health check failed"
            docker logs coldquery
            exit 1
          EOF

      - name: Cleanup old images on Pi
        run: |
          ssh ${{ env.PI_USER }}@${{ env.PI_HOST }} 'docker image prune -f'

      - name: Cleanup local artifacts
        if: always()
        run: rm -f image.tar ~/.ssh/id_ed25519
